name: Deploy to VPS

runs-on: ubuntu-latest

# Steps represent a sequence of tasks that will be executed as part of the job
steps:
  # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
  - name: Checkout the repository
    uses: actions/checkout@v2

  - name: Set up Go 1.23.4
    uses: actions/setup-go@v1
    with:
      go-version: 1.23.4

  - name: Build app
    run: go build -o app main.go

  - name: SCP to Ocean
    uses: appleboy/scp-action@master
    with:
      host: ${{ secrets.SERVER_IP }}
      username: root
      key: ${{ secrets.SSH_PRIVATE_KEY }}
      port: 8080
      source: "app"
      target: "dist"

  - name: Deploy and rebuild on server
    uses: appleboy/ssh-action@master
    with:
      host: ${{ secrets.SERVER_IP }}
      username: root
      key: ${{ secrets.SSH_PRIVATE_KEY }}
      port: 8080
      script: systemctl restart goweb.service &&
        systemctl status goweb
